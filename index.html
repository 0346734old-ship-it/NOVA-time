<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Timesheet - NOVA Racing</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    button.logout-btn {
      background: #d33;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Your Timesheet</h1>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <form id="timesheetForm">
      <input type="date" id="date" required />
      <input type="time" id="startTime" required />
      <input type="time" id="endTime" required />
      <button type="submit" class="primary-btn">Add Entry</button>
    </form>

    <table id="timesheetTable">
      <thead>
        <tr><th>Date</th><th>Start</th><th>End</th><th>Hours</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <!-- Entries appear here -->
      </tbody>
    </table>

    <p id="errorMsg" class="error"></p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCb1mVh5eZdzLn5oYvTO8F9BOVFAKYh2U",
      authDomain: "nova-8b407.firebaseapp.com",
      projectId: "nova-8b407",
      storageBucket: "nova-8b407.appspot.com",
      messagingSenderId: "1046397555152",
      appId: "1:1046397555152:web:eace78ab28fead1aae69d5",
      measurementId: "G-75PHS2PHY6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const timesheetForm = document.getElementById('timesheetForm');
    const timesheetTableBody = document.querySelector('#timesheetTable tbody');
    const errorMsg = document.getElementById('errorMsg');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUser = null;

    // Authentication state observer
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadTimesheetEntries();
      } else {
        window.location.href = 'login.html';
      }
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    timesheetForm.addEventListener('submit', async e => {
      e.preventDefault();
      errorMsg.textContent = '';

      const date = document.getElementById('date').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!date || !startTime || !endTime) {
        errorMsg.textContent = 'Please fill all fields.';
        return;
      }

      if (startTime >= endTime) {
        errorMsg.textContent = 'Start time must be before end time.';
        return;
      }

      const hours = (new Date(`1970-01-01T${endTime}`) - new Date(`1970-01-01T${startTime}`)) / 3600000;

      try {
        await db.collection('timesheets')
          .doc(currentUser.uid)
          .collection('entries')
          .add({ date, startTime, endTime, hours, timestamp: firebase.firestore.FieldValue.serverTimestamp() });

        timesheetForm.reset();
        loadTimesheetEntries();
      } catch (error) {
        errorMsg.textContent = error.message;
      }
    });

    async function loadTimesheetEntries() {
      timesheetTableBody.innerHTML = '';
      try {
        const snapshot = await db.collection('timesheets')
          .doc(currentUser.uid)
          .collection('entries')
          .orderBy('timestamp', 'desc')
          .get();

        if (snapshot.empty) {
          timesheetTableBody.innerHTML = '<tr><td colspan="5">No entries found.</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const { date, startTime, endTime, hours } = doc.data();

          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${date}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${hours.toFixed(2)}</td>
            <td><button data-id="${doc.id}" class="delete-btn">Delete</button></td>
          `;

          timesheetTableBody.appendChild(tr);
        });

        // Add delete button listeners
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            try {
              await db.collection('timesheets').doc(currentUser.uid).collection('entries').doc(id).delete();
              loadTimesheetEntries();
            } catch (error) {
              errorMsg.textContent = error.message;
            }
          });
        });
      } catch (error) {
        errorMsg.textContent = error.message;
      }
    }
  </script>
</body>
</html>
