<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - NOVA Racing</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      padding: 1rem;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    button.logout-btn {
      background: #d33;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .error {
      color: red;
    }
    .user-row:hover {
      background-color: #eef;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Panel - User Timesheets</h1>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div>
      <h2>Users</h2>
      <table id="usersTable">
        <thead>
          <tr><th>Email</th><th>User ID</th></tr>
        </thead>
        <tbody>
          <!-- Users will be loaded here -->
        </tbody>
      </table>
    </div>

    <div>
      <h2>User Timesheet Entries</h2>
      <table id="timesheetTable">
        <thead>
          <tr><th>Date</th><th>Start</th><th>End</th><th>Hours</th><th>Actions</th></tr>
        </thead>
        <tbody>
          <!-- Timesheet entries here -->
        </tbody>
      </table>
    </div>

    <p id="errorMsg" class="error"></p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCb1mVh5eZdzLn5oYvTO8F9BOVFAKYh2U",
      authDomain: "nova-8b407.firebaseapp.com",
      projectId: "nova-8b407",
      storageBucket: "nova-8b407.appspot.com",
      messagingSenderId: "1046397555152",
      appId: "1:1046397555152:web:eace78ab28fead1aae69d5",
      measurementId: "G-75PHS2PHY6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const usersTableBody = document.querySelector('#usersTable tbody');
    const timesheetTableBody = document.querySelector('#timesheetTable tbody');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMsg = document.getElementById('errorMsg');

    let users = [];
    let selectedUserId = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      if (user.email.toLowerCase() !== 'admin@nova.com') {
        window.location.href = 'index.html';
        return;
      }
      await loadUsers();
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    async function loadUsers() {
      usersTableBody.innerHTML = '';
      errorMsg.textContent = '';

      try {
        // Firestore doesn't store users in collection by default, you may want to keep users in a separate collection
        // Here we use Firebase Auth listUsers API only available via Admin SDK, so workaround: 
        // Instead, you can maintain a 'users' collection updated on registration.
        // For demo, we query all timesheet docs user IDs:

        const snapshot = await db.collection('timesheets').get();
        users = snapshot.docs.map(doc => doc.id);

        if (users.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="2">No users found.</td></tr>';
          return;
        }

        users.forEach(uid => {
          const tr = document.createElement('tr');
          tr.classList.add('user-row');
          tr.dataset.uid = uid;
          tr.innerHTML = `
            <td>${uid}</td>
            <td>${uid}</td>
          `;
          tr.addEventListener('click', () => {
            selectedUserId = uid;
            loadUserTimesheet(uid);
          });
          usersTableBody.appendChild(tr);
        });
      } catch (error) {
        errorMsg.textContent = error.message;
      }
    }

    async function loadUserTimesheet(uid) {
      timesheetTableBody.innerHTML = '';
      errorMsg.textContent = '';
      try {
        const snapshot = await db.collection('timesheets')
          .doc(uid)
          .collection('entries')
          .orderBy('timestamp', 'desc')
          .get();

        if (snapshot.empty) {
          timesheetTableBody.innerHTML = '<tr><td colspan="5">No entries found for this user.</td></tr>';
          return;
        }

        snapshot.forEach(doc => {
          const { date, startTime, endTime, hours } = doc.data();

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${date}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${hours.toFixed(2)}</td>
            <td><button data-id="${doc.id}" class="delete-btn">Delete</button></td>
          `;
          timesheetTableBody.appendChild(tr);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const entryId = e.target.dataset.id;
            try {
              await db.collection('timesheets').doc(selectedUserId).collection('entries').doc(entryId).delete();
              loadUserTimesheet(selectedUserId);
            } catch (error) {
              errorMsg.textContent = error.message;
            }
          });
        });

      } catch (error) {
        errorMsg.textContent = error.message;
      }
    }
  </script>
</body>
</html>
